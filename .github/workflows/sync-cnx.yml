# sync-cnx.yml
#
# GitHub Action que verifica se hÃ¡ atualizaÃ§Ãµes disponÃ­veis no template CNX
# e abre automaticamente um Pull Request com as melhorias.
#
# COMO FUNCIONA:
#   - Roda automaticamente toda segunda-feira Ã s 9h (horÃ¡rio de BrasÃ­lia)
#   - Pode ser executado manualmente a qualquer momento pela aba "Actions" no GitHub
#   - Baixa apenas os arquivos de CÃ“DIGO do template (nunca toca no seu conteÃºdo)
#   - Se houver novidades, abre um PR para vocÃª revisar e dar Merge
#
# ARQUIVOS QUE NUNCA SÃƒO ALTERADOS:
#   - src/content/  (seus posts, autores, categorias, pÃ¡ginas)
#   - public/images (suas imagens enviadas pelo painel)

name: ğŸ”„ Atualizar Template CNX

on:
  # Disparo manual pela aba "Actions" no GitHub
  workflow_dispatch:
    inputs:
      force:
        description: 'ForÃ§ar atualizaÃ§Ã£o mesmo sem mudanÃ§as detectadas?'
        required: false
        default: 'false'
        type: boolean

  # VerificaÃ§Ã£o automÃ¡tica toda segunda-feira Ã s 12h UTC (9h BrasÃ­lia)
  schedule:
    - cron: '0 12 * * 1'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Verificar e aplicar atualizaÃ§Ãµes
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Baixar repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”— Conectar ao template CNX original
        run: |
          git remote add template https://github.com/8linksapp-maker/cnx.git 2>/dev/null \
            || git remote set-url template https://github.com/8linksapp-maker/cnx.git
          git fetch template main --no-tags --quiet
          echo "âœ… Template CNX carregado com sucesso."

      - name: ğŸ“¦ Aplicar arquivos de cÃ³digo atualizados
        id: changes
        run: |
          # Copia apenas os arquivos de CÃ“DIGO do template
          # O conteÃºdo do aluno (src/content/ e public/images/) NÃƒO Ã© tocado
          git checkout template/main -- \
            src/components/ \
            src/layouts/ \
            src/pages/ \
            src/styles/ \
            src/themes/ \
            src/utils/ \
            src/middleware.ts \
            src/env.d.ts \
            astro.config.mjs \
            tailwind.config.mjs \
            tsconfig.json \
            package.json \
            bun.lock \
            public/favicon.ico \
            public/favicon.svg \
            VERSION \
            CHANGELOG.md \
            2>/dev/null || true

          # Verifica se houve mudanÃ§as reais
          if git diff --staged --quiet && [ "${{ inputs.force }}" != "true" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… Seu site jÃ¡ estÃ¡ na versÃ£o mais recente â€” nenhuma PR necessÃ¡ria."
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ AtualizaÃ§Ãµes encontradas nos seguintes arquivos:"
            git diff --staged --name-only || echo "(nenhuma mudanÃ§a staged)"
          fi

      - name: ğŸ“‹ Obter nova versÃ£o
        if: steps.changes.outputs.has_changes == 'true'
        id: version
        run: |
          NEW_VERSION=$(cat VERSION 2>/dev/null || echo "nova versÃ£o")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: ğŸš€ Criar Pull Request com as atualizaÃ§Ãµes
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        id: create_pr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: cnx-atualizacao
          base: main
          delete-branch: false
          title: 'ğŸ”„ AtualizaÃ§Ã£o CNX v${{ steps.version.outputs.new_version }} disponÃ­vel'
          body: |
            ## ğŸ”„ AtualizaÃ§Ã£o do Template CNX â€” v${{ steps.version.outputs.new_version }}

            HÃ¡ melhorias e correÃ§Ãµes disponÃ­veis no template.

            > âœ… **Seu conteÃºdo (posts, pÃ¡ginas, imagens) nÃ£o serÃ¡ alterado.**

            ğŸ“‹ [Ver o que mudou nesta versÃ£o](https://github.com/8linksapp-maker/cnx/blob/main/CHANGELOG.md)

            ---

            ### Como aplicar em 2 cliques:

            1. Clique no botÃ£o verde **"Merge pull request"** abaixo
            2. Clique em **"Confirm merge"**
            3. Aguarde ~2 minutos â€” seu site serÃ¡ reconstruÃ­do automaticamente âœ…

            ---

            > DÃºvidas? Entre em contato com o suporte do curso.
          labels: 'atualizaÃ§Ã£o'
          commit-message: 'chore: sync com template cnx v${{ steps.version.outputs.new_version }}'
          author: 'CNX Updates <noreply@cnx.app>'

      - name: ğŸ”€ Aplicar atualizaÃ§Ã£o automaticamente
        if: steps.changes.outputs.has_changes == 'true' && steps.create_pr.outputs.pull-request-number != ''
        run: |
          PR_NUMBER="${{ steps.create_pr.outputs.pull-request-number }}"
          echo "ğŸ”€ Aplicando PR #${PR_NUMBER} automaticamente..."
          gh pr merge "${PR_NUMBER}" --merge --auto --delete-branch \
            --body "âœ… Aplicado automaticamente pelo CNX Updater" \
            || echo "âš ï¸ Auto-merge nÃ£o disponÃ­vel agora â€” o PR permanece aberto para revisÃ£o manual."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Resumo
        run: |
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "ğŸš€ AtualizaÃ§Ã£o aplicada automaticamente. A Vercel reconstruirÃ¡ o site em ~1 min."
          else
            echo "âœ… Nenhuma atualizaÃ§Ã£o disponÃ­vel no momento."
          fi
