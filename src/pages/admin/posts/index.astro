---
/**
 * admin/posts/index.astro
 * 
 * P√°gina de listagem de todos os posts do blog.
 * Exibe tabela com posts, filtros, busca e a√ß√µes (editar, deletar, duplicar).
 * Design moderno integrado ao painel admin.
 */

import { getCollection, getEntry } from 'astro:content';
import AdminLayout from '../../../layouts/AdminLayout.astro';

const posts = await getCollection('posts');
const authors = await getCollection('authors');
const categories = await getCollection('categories');

// Ordenar por data (mais recentes primeiro)
const sortedPosts = [...posts].sort((a, b) => {
    const dateA = a.data.publishedDate ? new Date(a.data.publishedDate).getTime() : 0;
    const dateB = b.data.publishedDate ? new Date(b.data.publishedDate).getTime() : 0;
    return dateB - dateA;
});

function formatDate(dateString: string | undefined) {
    if (!dateString) return 'Rascunho';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR', { 
            day: '2-digit', 
            month: 'short',
            year: 'numeric'
        });
    } catch {
        return 'Data inv√°lida';
    }
}

function getAuthorName(authorSlug: string | undefined) {
    if (!authorSlug) return 'Sem autor';
    const author = authors.find(a => a.id === authorSlug);
    return author?.data.name || authorSlug;
}

function getCategoryName(categorySlug: string | undefined) {
    if (!categorySlug) return 'Sem categoria';
    const category = categories.find(c => c.id === categorySlug);
    return category?.data.name || categorySlug;
}
---

<AdminLayout title="Posts - CNX Agency Admin">
    <!-- Page Header -->
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-heading font-bold text-[#e5e5e5] mb-1">
                Posts
            </h1>
            <p class="text-[#a3a3a3] text-sm">
                Gerencie todos os posts do seu blog
            </p>
        </div>
        <div class="flex gap-2">
            <a 
                href="/admin/posts/ai"
                class="admin-btn admin-btn-primary flex items-center gap-2"
            >
                <span>‚ú®</span>
                Posts com IA
            </a>
            <a 
                href="/admin/posts/new"
                class="admin-btn admin-btn-secondary flex items-center gap-2"
            >
                <span>‚ûï</span>
                Novo Post
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="p-4 rounded-xl bg-white/5 border border-white/10">
            <div class="text-2xl font-heading font-black text-white">{posts.length}</div>
            <div class="text-sm text-slate-400">Total de Posts</div>
        </div>
        <div class="p-4 rounded-xl bg-white/5 border border-white/10">
            <div class="text-2xl font-heading font-black text-green-400">
                {posts.filter(p => p.data.publishedDate).length}
            </div>
            <div class="text-sm text-slate-400">Publicados</div>
        </div>
        <div class="p-4 rounded-xl bg-white/5 border border-white/10">
            <div class="text-2xl font-heading font-black text-yellow-400">
                {posts.filter(p => !p.data.publishedDate).length}
            </div>
            <div class="text-sm text-slate-400">Rascunhos</div>
        </div>
        <div class="p-4 rounded-xl bg-white/5 border border-white/10">
            <div class="text-2xl font-heading font-black text-primary">
                {authors.length}
            </div>
            <div class="text-sm text-slate-400">Autores</div>
        </div>
    </div>

    <!-- Posts Table -->
    <div class="admin-card overflow-hidden">
        {sortedPosts.length > 0 ? (
            <div class="overflow-x-auto">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>T√≠tulo</th>
                            <th>Autor</th>
                            <th>Categoria</th>
                            <th>Data</th>
                            <th>Status</th>
                            <th class="text-right">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {sortedPosts.map((post) => {
                            const isPublished = !!post.data.publishedDate;
                            return (
                                <tr>
                                    <td>
                                        <div class="font-semibold text-[#e5e5e5] mb-1">{post.data.title}</div>
                                        <div class="text-xs text-[#737373] font-mono">/{post.data.slug}</div>
                                    </td>
                                    <td class="text-sm text-[#a3a3a3]">
                                        {getAuthorName(post.data.author)}
                                    </td>
                                    <td>
                                        {post.data.category ? (
                                            <span class="admin-badge admin-badge-neutral">
                                                {getCategoryName(post.data.category)}
                                            </span>
                                        ) : (
                                            <span class="text-[#737373] text-xs">‚Äî</span>
                                        )}
                                    </td>
                                    <td class="text-sm text-[#a3a3a3]">
                                        {formatDate(post.data.publishedDate)}
                                    </td>
                                    <td>
                                        <span class="admin-badge admin-badge-neutral">
                                            {isPublished ? 'Publicado' : 'Rascunho'}
                                        </span>
                                    </td>
                                    <td class="text-right">
                                        <div class="flex items-center justify-end gap-2">
                                            <a 
                                                href={`/admin/posts/${post.data.slug}`}
                                                class="admin-btn admin-btn-ghost text-sm"
                                            >
                                                Editar
                                            </a>
                                            <a 
                                                href={`/blog/${post.id}`}
                                                target="_blank"
                                                class="admin-btn admin-btn-secondary text-sm"
                                            >
                                                Ver
                                            </a>
                                            <button
                                                type="button"
                                                data-slug={post.data.slug}
                                                data-title={post.data.title}
                                                class="admin-btn admin-btn-danger text-sm delete-post-btn"
                                            >
                                                üóëÔ∏è Deletar
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
        ) : (
            <div class="p-12 text-center">
                <p class="text-[#a3a3a3] mb-4">Nenhum post encontrado</p>
                <a 
                    href="/admin/posts/new"
                    class="admin-btn admin-btn-primary inline-block"
                >
                    Criar Primeiro Post
                </a>
            </div>
        )}
    </div>
    </div>

    <!-- Modal de confirma√ß√£o de dele√ß√£o -->
    <div id="delete-modal-backdrop" class="admin-modal-backdrop" style="display: none;">
        <div class="admin-modal">
            <div class="admin-modal-header">
                <div class="admin-modal-icon">
                    <span>‚úñ</span>
                </div>
                <div>
                    <div class="admin-modal-title">Excluir post</div>
                </div>
            </div>
            <div class="admin-modal-body">
                <p id="delete-modal-message">
                    Tem certeza que deseja excluir este post?
                </p>
                <small>
                    Esta a√ß√£o √© permanente e n√£o poder√° ser desfeita. O conte√∫do ser√° removido
                    do blog e do CMS.
                </small>
            </div>
            <div class="admin-modal-footer">
                <button 
                    type="button" 
                    class="admin-modal-btn admin-modal-btn-cancel" 
                    id="delete-modal-cancel"
                >
                    Cancelar
                </button>
                <button 
                    type="button" 
                    class="admin-modal-btn admin-modal-btn-danger" 
                    id="delete-modal-confirm"
                >
                    Excluir definitivamente
                </button>
            </div>
        </div>
    </div>

    <!-- Toast de feedback -->
    <div id="admin-toast" class="admin-toast admin-toast--error" style="display: none;">
        <div class="admin-toast-icon">
            <span id="admin-toast-icon">‚ùå</span>
        </div>
        <div class="admin-toast-content">
            <strong id="admin-toast-title">Erro ao excluir post</strong>
            <span id="admin-toast-message">Ocorreu um erro inesperado.</span>
        </div>
        <button 
            type="button" 
            class="admin-toast-close" 
            aria-label="Fechar notifica√ß√£o"
        >
            √ó
        </button>
    </div>
</AdminLayout>

<script is:inline>
    (function() {
        const backdrop = document.getElementById('delete-modal-backdrop');
        const confirmBtn = document.getElementById('delete-modal-confirm');
        const cancelBtn = document.getElementById('delete-modal-cancel');
        const messageEl = document.getElementById('delete-modal-message');
        const toastEl = document.getElementById('admin-toast');
        const toastMessageEl = document.getElementById('admin-toast-message');
        const toastTitleEl = document.getElementById('admin-toast-title');
        const toastIconEl = document.getElementById('admin-toast-icon');
        const toastClose = toastEl ? toastEl.querySelector('.admin-toast-close') : null;

        let currentSlug = null;
        let currentTitle = null;

        function openModal(slug, title) {
            currentSlug = slug;
            currentTitle = title;
            if (messageEl) {
                messageEl.textContent = `Tem certeza que deseja excluir o post \"${title}\"?`;
            }
            if (backdrop) {
                backdrop.style.display = 'flex';
            }
        }

        function closeModal() {
            currentSlug = null;
            currentTitle = null;
            if (backdrop) {
                backdrop.style.display = 'none';
            }
        }

        function showToast(message, type) {
            if (!toastEl || !toastMessageEl) return;
            var isSuccess = type === 'success';
            toastEl.className = 'admin-toast ' + (isSuccess ? 'admin-toast--success' : 'admin-toast--error');
            if (toastIconEl) toastIconEl.textContent = isSuccess ? '‚úÖ' : '‚ùå';
            if (toastTitleEl) toastTitleEl.textContent = isSuccess ? 'Post exclu√≠do!' : 'Erro ao excluir post';
            toastMessageEl.textContent = message;
            toastEl.style.display = 'flex';
            setTimeout(() => {
                toastEl.style.display = 'none';
            }, isSuccess ? 8000 : 5000);
        }

        async function handleDeletePost() {
            if (!currentSlug || !currentTitle) {
                showToast('Dados do post n√£o encontrados. Tente recarregar a p√°gina.', 'error');
                return;
            }

            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Excluindo...';
            }

            try {
                const response = await fetch(`/api/admin/posts/${currentSlug}`, {
                    method: 'DELETE',
                });

                const result = await response.json();

                if (result.success) {
                    const row = document.querySelector(`button[data-slug=\"${currentSlug}\"]`)?.closest('tr');
                    if (row) {
                        row.style.opacity = '0.4';
                        row.style.transition = 'opacity 0.3s';
                        setTimeout(() => {
                            if (row.parentElement) row.parentElement.removeChild(row);
                        }, 300);
                    }
                    closeModal();
                    showToast('O arquivo foi removido do GitHub. A Vercel est√° reconstruindo o site ‚Äî o post desaparecer√° do blog em 1 a 2 minutos.', 'success');
                } else {
                    showToast(result.error || 'Erro desconhecido ao deletar post.', 'error');
                }
            } catch (error) {
                console.error('‚ùå Erro ao deletar post:', error);
                showToast('Erro ao deletar post. Verifique o console para mais detalhes.', 'error');
            } finally {
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Excluir definitivamente';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const deleteButtons = document.querySelectorAll('.delete-post-btn');

            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const slug = this.getAttribute('data-slug');
                    const title = this.getAttribute('data-title');

                    if (slug && title) {
                        openModal(slug, title);
                    } else {
                        console.error('‚ùå Erro: slug ou title n√£o encontrado');
                        showToast('N√£o foi poss√≠vel identificar o post selecionado.');
                    }
                });
            });

            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeModal);
            }

            if (confirmBtn) {
                confirmBtn.addEventListener('click', handleDeletePost);
            }

            if (toastClose && toastEl) {
                toastClose.addEventListener('click', () => {
                    toastEl.style.display = 'none';
                });
            }

            if (backdrop) {
                backdrop.addEventListener('click', (event) => {
                    if (event.target === backdrop) {
                        closeModal();
                    }
                });
            }
        });
    })();
</script>
