---
/**
 * AdminLayout.astro
 * 
 * Layout base para todas as páginas do painel administrativo.
 * Fornece estrutura com sidebar fixa, header e área de conteúdo principal.
 * Design moderno e profissional, rival do WordPress em UX mas superior em performance.
 * 
 * Componentes incluídos:
 * - Sidebar de navegação fixa
 * - Header com busca e ações rápidas
 * - Área de conteúdo responsiva
 * - Sistema de cores dinâmico baseado no tema ativo
 */

import AdminSidebar from '../components/admin/Sidebar.astro';
import AdminHeader from '../components/admin/Header.astro';
import { verifySession, SESSION_COOKIE } from '../utils/auth-utils';
import '../styles/global.css';
import '../styles/admin.css';
import '../styles/blocknote.css';
import '@fontsource/inter';
import '@fontsource/outfit';

interface Props {
    title?: string;
    description?: string;
}

const { 
    title = "Painel Administrativo",
    description = "Gerencie seu site com facilidade e performance"
} = Astro.props;

// Verificar sessão DIRETAMENTE do cookie — não depende do middleware
const token = Astro.cookies.get(SESSION_COOKIE)?.value;
const currentUser = token ? verifySession(token) : null;

// Redirecionar para login se não autenticado
if (!currentUser) {
    return Astro.redirect('/admin/login');
}

const primaryColor = '#a855f7';
const secondaryColor = '#ec4899';
const borderRadius = '16px';

// Helper para converter hex para RGB
function hexToRgb(hex: string) {
    if (!hex || typeof hex !== 'string' || !hex.startsWith('#')) return '168 85 247';
    try {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        if (isNaN(r) || isNaN(g) || isNaN(b)) return '168 85 247';
        return `${r} ${g} ${b}`;
    } catch {
        return '168 85 247';
    }
}

const primaryRGB = hexToRgb(primaryColor);
const secondaryRGB = hexToRgb(secondaryColor);
---

<!doctype html>
<html lang="pt-BR" class="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="generator" content={Astro.generator} />
        <title>{title}</title>
        <meta name="description" content={description} />

        <!-- Theme Variables -->
        <style is:global define:vars={{ primaryRGB, secondaryRGB, borderRadius }}>
            :root {
                --primary-rgb: var(--primaryRGB);
                --secondary-rgb: var(--secondaryRGB);
                --radius: var(--borderRadius);
            }
        </style>

        <!-- Anti-flash: aplica o tema salvo ANTES de renderizar qualquer pixel -->
        <script is:inline>
            (function () {
                try {
                    var saved = localStorage.getItem('cnx-theme');
                    var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    var theme = saved || (prefersDark ? 'dark' : 'light');
                    var html = document.documentElement;
                    html.classList.remove('dark', 'light');
                    html.classList.add(theme);
                } catch (e) {}
            })();
        </script>
    </head>
    <body class="font-sans antialiased min-h-screen" style="background: var(--admin-bg); color: var(--admin-text);">
        <!-- Background -->
        <div class="fixed inset-0 -z-10 h-full w-full" style="background: var(--admin-bg);"></div>

        <div class="flex h-screen overflow-hidden">
            <!-- Sidebar -->
            <AdminSidebar user={currentUser} />

            <!-- Main Content Area -->
            <div class="flex flex-col flex-1 overflow-hidden">
                <!-- Header -->
                <AdminHeader user={currentUser} />

                <!-- Page Content -->
                <main class="flex-1 overflow-y-auto p-6 lg:p-8">
                    <slot />
                </main>
            </div>
        </div>
    </body>
</html>
